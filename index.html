<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUNBLANK｜memories</title>
<link rel="stylesheet" href="css/common.css">
</head>
<body>

<header>
  <h1>SUNBLANK｜memories</h1>
</header>
<nav>
  <ul>
    <li><a href="album/index.html">アルバム</a></li>
    <li><a href="comment/index.html">コメント</a></li>
    <li><a href="request/index.html">リクエスト</a></li>
  </ul>
</nav>

<main class="container">

  <!-- ▼ 旅の計画 -->
  <h2 class="section-title">旅の計画</h2>
  <section class="events">
    <a href="kusatsu2026/index.html" class="event">
      <img src="kusatsu2026/thumb.jpg" alt="草津温泉">
      <span>草津温泉旅行（案）</span>
    </a>
    <a href="arima2026/index.html" class="event">
      <img src="arima2026/thumb.jpg" alt="有馬温泉">
      <span>有馬温泉旅行(案）</span>
    </a>
    <a href="katsunuma2026/index.html" class="event">
      <img src="katsunuma2026/thumb.jpg" alt="ぶどうの丘">
      <span>山梨県勝沼市ぶどうの丘旅（案）</span>
    </a>
  </section>

  <!-- ▼ 思い出アルバム -->
  <h2 class="section-title">思い出アルバム</h2>
  <section class="album grid-auto" id="album-grid"></section>

  <!-- ▼ 思い出コメント -->
  <h2 class="section-title">思い出コメント</h2>
  <section class="card">
    <form id="memories-form" onsubmit="event.preventDefault(); postMessage('memories');">
      <label for="memories-name">名前:</label>
      <input id="memories-name" required>
      <label for="memories-text">コメント:</label>
      <textarea id="memories-text" required></textarea>
      <label for="memories-file">画像:</label>
      <input type="file" id="memories-file">
      <button type="submit" class="submit-btn">投稿</button>
    </form>
    <ul id="memories-list"></ul>
  </section>

  <!-- ▼ イベントリクエスト -->
  <h2 class="section-title">イベントリクエスト</h2>
  <section class="card">
    <form id="requests-form" onsubmit="event.preventDefault(); postMessage('requests');">
      <label for="requests-name">名前:</label>
      <input id="requests-name" required>
      <label for="requests-text">リクエスト:</label>
      <textarea id="requests-text" required></textarea>
      <label for="requests-file">画像:</label>
      <input type="file" id="requests-file">
      <button type="submit" class="submit-btn">投稿</button>
    </form>
    <ul id="requests-list"></ul>
  </section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
  from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMynBwvGhlGbEi6UCHrZjYHNedf9pqXJQ",
  authDomain: "sunblank-memories.firebaseapp.com",
  projectId: "sunblank-memories",
  storageBucket: "sunblank-memories.appspot.com",
  messagingSenderId: "916551819188",
  appId: "1:916551819188:web:741bfd8c4534b511e35ce1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

async function postMessage(type) {
  const name = document.getElementById(type + "-name").value;
  const text = document.getElementById(type + "-text").value;
  const file = document.getElementById(type + "-file").files[0];
  let imageUrl = "";

  if (file) {
    const storageRef = ref(storage, type + "/" + file.name);
    await uploadBytes(storageRef, file);
    imageUrl = await getDownloadURL(storageRef);
  }

  await addDoc(collection(db, type), {
    name, text, imageUrl, createdAt: serverTimestamp()
  });

  document.getElementById(type + "-form").reset();
}

function listenMessages(type, listId, isAlbum=false) {
  const q = query(collection(db, type), orderBy("createdAt","desc"));
  onSnapshot(q, (snapshot) => {
    const list = document.getElementById(listId);
    list.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      if(isAlbum && data.imageUrl){
        const img = document.createElement("img");
        img.src = data.imageUrl;
        list.appendChild(img);
      } else {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${data.name}</strong>: ${data.text}
          ${data.imageUrl ? `<br><img src="${data.imageUrl}">` : ""}`;
        list.appendChild(li);
      }
    });
  });
}

// 起動時に監視開始
listenMessages("memories","memories-list");
listenMessages("requests","requests-list");
listenMessages("memories","album-grid",true); // アルバム用
</script>

</body>
</html>